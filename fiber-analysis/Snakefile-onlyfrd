rule all:
    input:
        "results/{date}/{setup}/{serial}/{filename}.fits"  # Specify the final output files generated by frd_test

# Rule to run the FRD setup automation (this will execute first to generate the FITS images)
rule frd_test:
    output:
        "results/{date}/{setup}/{serial}/{filename}.fits"  # Output file will be the .fits image
    shell:
        """
        jupyter nbconvert --to notebook --execute frd-setup-automation.ipynb \
        --output notebooks/executed_frd_setup.ipynb --ExecutePreprocessor.timeout=-1
        """

# Rule to analyze a FRD image (it runs after the .fits image is generated)
rule frd_analysis:
    input:
        "results/{date}/{setup}/{serial}/{filename}.fits"  # Input is the .fits image generated by frd_test
    output:
        "notebooks/executed_frd_analysis_{filename}.ipynb",  # Output executed notebook for each image
        "results/{filename}_analysis.png"  # Output analysis plot for each image
    shell:
        """
        mkdir -p notebooks
        jupyter nbconvert --to notebook --execute frd-analysis.ipynb \
        --output notebooks/executed_frd_analysis_{wildcards.filename}.ipynb \
        --ExecutePreprocessor.timeout=-1 \
        --ExecutePreprocessor.kernel_name=python3 \
        --ExecutePreprocessor.allow_errors=True \
        -- -- {input}
        """

